---
title: "OpenResty + Luaã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ãéš›ã«ãƒãƒã£ãŸã“ã¨"
emoji: "ğŸŒ’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["lua", "busted", "OpenResty", "nginx"]
published: true
---

## ã“ã‚Œã¯ä½•?

OpenRestyç’°å¢ƒã§ä½¿ç”¨ã—ã¦ã„ã‚‹Lua Scriptã®ã‚·ã‚¹ãƒ†ãƒ ã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ããŸã„ã¨æ€ã£ãŸã®ã§ã™ãŒï¼Œãã“ãã“è©°ã¾ã‚‹éƒ¨åˆ†ãŒã‚ã£ãŸã®ã§è©°ã¾ã£ãŸéƒ¨åˆ†ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

---

## ç’°å¢ƒ

- OpenResty 1.21.4.1
- busted: Lua Scriptã®å˜ä½“ãƒ†ã‚¹ãƒˆç”¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

è©³ã—ãã¯[è‡ªåˆ†ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/RyosukeDTomita/GateKeeper)å‚ç…§ã€‚

---

## ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆâ‘ LuaJITã¨Luaã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚ã£ã¦ã„ãªã„éš›ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã†ã¾ãå‹•ã‹ãªã„ã“ã¨ãŒã‚ã‚‹

### äº‹è±¡: bustedãŒã†ã¾ãå®Ÿè¡Œã§ããªã„ 

```
/usr/local/openresty/luajit/bin/luajit: /usr/local/openresty/lua54/bin/busted:3: unexpected symbol near '-'
```

#### å‰æ: LuaJITã¨ã¯

> LuaJIT is a Just-In-Time Compiler for the Lua programming language.
> Homepage: http://luajit.org/luajit.html
> LuaJIT is enabled by default since OpenResty 1.5.8.1. Please explicitly specify the --with-luajit option while configuring OpenResty older than 1.5.8.1. See Installation for details.
> [OpenRestyå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆLuaJIT](https://openresty.org/en/luajit.html)

:::message
å®Ÿè¡Œæ™‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ï¼ˆã˜ã£ã“ã†ã˜ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã€just-in-time compilerã€JITã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ï¼‰ã¨ã¯ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®å®Ÿè¡Œæ™‚ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ã“ã¨ã€‚[Wikipedia](https://ja.wikipedia.org/wiki/%E5%AE%9F%E8%A1%8C%E6%99%82%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9)ã‚ˆã‚Š
:::

OpenRestyã¯1.5.8.1ä»¥é™ã¯LuaJITã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
LuaJITã‚’ä½¿ã†ã“ã¨ã§é€šå¸¸ã®Luaã‚ˆã‚Šã‚‚é«˜é€Ÿã«å‹•ä½œã—ã¾ã™ã€‚

### è§£æ±ºç­–: LuaRocksã§ãƒ™ãƒ¼ã‚¹ã¨ã™ã‚‹Luaã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’LuaJITã«ã‚ã‚ã›ã‚‹

- LuaRocksã¯Luaã§ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç®¡ç†ãƒ„ãƒ¼ãƒ«
- LuaRocksã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯[HereRocks](https://github.com/mpeterv/hererocks)ã‚’ä½¿ã†ã¨Luaã‚„LuaJITã¨ã‚»ãƒƒãƒˆã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹

è‡ªåˆ†ã¯ã‚‚ã¨ã‚‚ã¨ï¼ŒLua5.4ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸãŒï¼Œ[LuaJITã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://luajit.org/luajit.html)ã«ã‚ˆã‚‹ã¨LuaJITã¯Lua5.1ã‚’ãƒ™ãƒ¼ã‚¹ã«ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãŸã‚ï¼ŒLuaRocksã‚’Lua5.1ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã¯luajit 2.1.0-beta3ã«ã‚ã‚ã›ã¦luarocksã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ä¾‹ã§ã™

```shell
usr/local/openresty/luajit/bin/luajit -v
LuaJIT 2.1.0-beta3 -- Copyright (C) 2005-2022 Mike Pall. https://luajit.org/
hererocks luajit21 -j 2.1.0-beta3 -r latest
```

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã£ã¦ã¯æœ€æ–°ã®Lua5.4ã«ã‚ã‚ã›ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‚å‹•ãã‚‚ã®ã‚‚ã‚ã‚Šãã†ã ãŒï¼Œç„¡é›£ã«LuaJITã«åˆã‚ã›ã‚‹ã¹ãã¨æ€ã‚ã‚Œã‚‹ã€‚

---

## ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆâ‘¡`LUA_PATH`ã®exportãŒå¿…è¦

### äº‹è±¡: module not foundã‚¨ãƒ©ãƒ¼ãŒã§ã‚‹

ä»¥ä¸‹ã¯è‡ªåˆ†ã®`busted`ã®å®Ÿè¡Œä¾‹ã§ã™ãŒï¼Œ`LUA_PATH`ãŒé€šã£ã¦ã„ãªã„ã¨.soã‚’æ¢ã—ã¦è¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼ãŒã§ã¾ã™ã€‚

<details><summary>ã‚¨ãƒ©ãƒ¼åˆ†ã®è©³ç´°</summary>

```
/usr/local/openresty/luajit21/bin/busted -p _test tests

Error â†’ tests/auth_factory_test.lua @ 1
auth_factory.lua get_auth_instance
./src/auth_factory.lua:2: module 'basic_auth' not found:No LuaRocks module found for basic_auth
        no field package.preload['basic_auth']
        no file './src/basic_auth.lua'
        no file './src/basic_auth/basic_auth.lua'
        no file './src/basic_auth/init.lua'
        no file '/usr/local/openresty/luajit21/share/lua/5.1/basic_auth.lua'
        no file '/usr/local/openresty/luajit21/share/lua/5.1/basic_auth/init.lua'
        no file '/root/.luarocks/share/lua/5.1/basic_auth.lua'
        no file '/root/.luarocks/share/lua/5.1/basic_auth/init.lua'
        no file './csrc/basic_auth.so'
        no file './csrc/basic_auth/basic_auth.so'
        no file '/usr/local/openresty/luajit21/lib/lua/5.1/basic_auth.so'
        no file './basic_auth.so'
        no file '/usr/local/openresty/luajit21/lib/lua/5.1/loadall.so'
        no file '/root/.luarocks/lib/lua/5.1/basic_auth.so'
/usr/local/openresty/reverse_proxy/tests

```
</details>

### è§£æ±ºç­–: `LUA_PATH`ã®export

`LUA_PATH`ã®å†…å®¹ã¯nginx.confã«è¨˜è¼‰ã®ã‚ã‚‹`lua_package_path`ã‚’ã‚³ãƒ”ãƒšã—ã¾ã—ãŸã€‚TODO: å¿…è¦æœ€ä½é™ã‚’æ¢ã—ã¦ã‚‚ã„ã„ã‹ã‚‚

```shell
export LUA_PATH="/usr/local/openresty/lualib/?.lua;/usr/local/openresty/luajit/libs/?.lua;/usr/local/openresty/luajit/share/luajit-2.1.0-beta3/jit/?.lua;/usr/local/openresty/reverse_proxy/src/?.lua;/usr/local/openresty/reverse_proxy/src/auth/?.lua;/usr/local/openresty/lualib/resty/?.lua;/usr/local/openresty/lualib/ngx/?.lua;/usr/local/openresty/?.lua;/usr/local/openresty/luajit21/share/lua/5.1/?.lua"
```

---

## ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆâ‘¢bustedå®Ÿè¡Œæ™‚ã«LuaJITã«ä¾å­˜ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½¿ãˆãªã„

### äº‹è±¡: ffi not foundã‚¨ãƒ©ãƒ¼ãŒã§ã‚‹

```
/usr/local/openresty/lua54/share/lua/5.4/resty/md5.lua:4: module 'ffi' not found:
        No LuaRocks module found for ffi
        no field package.preload['ffi']
        no file './src/ffi.lua'
        no file './src/ffi/ffi.lua'
        no file './src/ffi/init.lua'
        no file '/usr/local/openresty/lua54/share/lua/5.4/ffi.lua'
        no file '/usr/local/openresty/lua54/share/lua/5.4/ffi/init.lua'
        no file '/usr/local/openresty/lualib/ffi.lua'
        no file '/usr/local/openresty/luajit/libs/ffi.lua'
        no file '/usr/local/openresty/luajit/share/luajit-2.1.0-beta3/jit/ffi.lua'
        no file '/usr/local/openresty/reverse_proxy/src/ffi.lua'
        no file '/usr/local/openresty/reverse_proxy/src/auth/ffi.lua'
        no file '/usr/local/openresty/lualib/resty/ffi.lua'
        no file '/usr/local/openresty/lualib/ngx/ffi.lua'
        no file '/usr/local/openresty/ffi.lua'
        no file '/root/.luarocks/share/lua/5.4/ffi.lua'
        no file '/root/.luarocks/share/lua/5.4/ffi/init.lua'
        no file './csrc/ffi.so'
        no file './csrc/ffi/ffi.so'
        no file '/usr/local/openresty/lua54/lib/lua/5.4/ffi.so'
        no file '/usr/local/openresty/lua54/lib/lua/5.4/loadall.so'
        no file './ffi.so'
        no file '/root/.luarocks/lib/lua/5.4/ffi.so'
```

### è§£æ±ºç­–: ffiã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«bustedã®å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹

ä¸€éƒ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯LuaJitã§ã®ã¿ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹`ffi`ã«ä¾å­˜ã—ã¾ã™ã€‚
èª¿æŸ»ã—ãŸã¨ã“ã‚ï¼Œä»¥ä¸‹ã®ã‚ˆã†ã«fflã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚Œã°è§£æ±ºã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

https://github.com/lunarmodules/busted/issues/369

ä»¥ä¸‹ã¯å®Ÿè¡Œä¾‹ã§ã™ã€‚

```helper.lua
local ffi = require "ffi"
```

```shell
export LUA_PATH="/usr/local/openresty/lualib/?.lua;/usr/local/openresty/luajit/libs/?.lua;/usr/local/openresty/luajit/share/luajit-2.1.0-beta3/jit/?.lua;/usr/local/openresty/reverse_proxy/src/?.lua;/usr/local/openresty/reverse_proxy/src/auth/?.lua;/usr/local/openresty/lualib/resty/?.lua;/usr/local/openresty/lualib/ngx/?.lua;/usr/local/openresty/?.lua;/usr/local/openresty/luajit21/share/lua/5.1/?.lua"

pushd ../
    # NOTE: ffiã¯luajitã§ã®ã¿ã—ã‹ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ï¼Œhttps://github.com/lunarmodules/busted/issues/369 ã‚’å‚è€ƒã«ä¿®æ­£
    /usr/local/openresty/luajit21/bin/busted --helper=/usr/local/openresty/reverse_proxy/tests/helper.lua -p _test tests
popd

```

---

## ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆâ‘£OpenRestyãŒçµ¡ã‚€éƒ¨åˆ†ã§`ngx`å¤‰æ•°å‘¨ã‚Šã®nilã«å¯¾å‡¦ãŒå¿…è¦

### äº‹è±¡: nilã‚¨ãƒ©ãƒ¼ãŒã§ã¦ã„ã‚‹

ä»¥ä¸‹ã¯å®Ÿè¡Œä¾‹ã§ã™ã€‚

```
/usr/local/openresty/reverse_proxy /usr/local/openresty/reverse_proxy/tests
âœ±
0 successes / 0 failures / 1 error / 0 pending : 0.001674 seconds

Error â†’ tests/auth_factory_test.lua @ 1
auth_factory.lua get_auth_instance
...ocal/openresty/luajit21/share/lua/5.1/resty/template.lua:147: attempt to index field 'location' (a nil value)
/usr/local/openresty/reverse_proxy/tests

```

### è§£æ±ºç­–: ngxã‚’Mockã™ã‚‹

æœ‰å¿—ãŒä½œã£ã¦ã„ãŸfakengxã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚‚ã‚ã‚‹ã‚ˆã†ã§ã™ãŒï¼Œç¾åœ¨ã¯Public Archiveã«ãªã£ã¦ã„ã‚‹ã®ã§ï¼Œå¿…è¦ãªå¤‰æ•°ã®ã¿ã‚’è‡ªå‰ã§ãƒ¢ãƒƒã‚¯ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

https://github.com/bsm/fakengx

GitHub Copilot Chat/Editç­‰ã«ã‚¨ãƒ©ãƒ¼æ–‡ã‚’ã„ã‚Œã‚‹ã¨å‹æ‰‹ã«Mockå†…å®¹ã‚’å¢—ã‚„ã—ã¦ãã‚Œã‚‹ã§ï¼Œã„ã„æ™‚ä»£ã«ãªã‚Šã¾ã—ãŸã­ã€‚

```lua
describe("auth_factory.lua get_auth_instance", function()
    -- NOTE: ngxã®ãƒ¢ãƒƒã‚¯ãŒå¿…è¦ã ã£ãŸã®ã§é›‘ã«ä½œæˆã€‚ngxã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹å…¬å¼ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ãªã•ãã†
    _G.ngx = {
        var = {},
        log = function() end,
        ERR = "ERR",
        INFO = "INFO",
        HTTP_INTERNAL_SERVER_ERROR = 500,
        exit = function() end,
        re = {match = function() return nil end},
        location = {},
        config = {prefix = function()
            return "/usr/local/openresty/nginx/"
        end},
        get_phase = function() return "init" end,
        socket = {
            tcp = function()
                return {
                    settimeout = function() end,
                    connect = function() return true end,
                    setkeepalive = function() end,
                    close = function() end,
                    send = function() return true end,
                    receive = function() return nil end
                }
            end
        }
    }
```

---

## æœ€å¾Œã«: ã‚µãƒ³ãƒ—ãƒ«

### è¢«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã£ã¦å¿…è¦ãªèªè¨¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™é–¢æ•°ã§ã™ã€‚

```lua
local _M = {}
local basic_auth = require "basic_auth"
local digest_auth = require "digest_auth"
local form_auth = require "form_auth"

local _M = {}

function _M.get_auth_instance(auth_type)
    if auth_type == "basic" then
        return require "basic_auth"
    elseif auth_type == "digest" then
        return require "digest_auth"
    elseif auth_type == "form" then
        return require "form_auth"
    else
        error("Invalid authentication type: " .. auth_type)
    end
end

return _M
```

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```lua
describe("auth_factory.lua get_auth_instance", function()
    -- NOTE: ngxã®ãƒ¢ãƒƒã‚¯ãŒå¿…è¦ã ã£ãŸã®ã§é›‘ã«ä½œæˆã€‚ngxã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹å…¬å¼ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ãªã•ãã†
    _G.ngx = {
        var = {},
        log = function() end,
        ERR = "ERR",
        INFO = "INFO",
        HTTP_INTERNAL_SERVER_ERROR = 500,
        exit = function() end,
        re = {match = function() return nil end},
        location = {},
        config = {prefix = function()
            return "/usr/local/openresty/nginx/"
        end},
        get_phase = function() return "init" end,
        socket = {
            tcp = function()
                return {
                    settimeout = function() end,
                    connect = function() return true end,
                    setkeepalive = function() end,
                    close = function() end,
                    send = function() return true end,
                    receive = function() return nil end
                }
            end
        }
    }

    local auth_factory = require "auth_factory"

    it("should return basic auth instance", function()
        local auth_instance = auth_factory.get_auth_instance("basic")
        assert.is.equal(auth_instance, require "basic_auth")
    end)

    it("should return digest auth instance", function()
        local auth_instance = auth_factory.get_auth_instance("digest")
        assert.is.equal(auth_instance, require "digest_auth")
    end)

    it("should return form auth instance", function()
        local auth_instance = auth_factory.get_auth_instance("form")
        assert.is.equal(auth_instance, require "form_auth")
    end)

    it("should throw error for invalid auth type", function()
        assert.has_error(function()
            auth_factory.get_auth_instance("invalid")
        end, "Invalid authentication type: invalid")
    end)
end)

```

```run-test.sh
#!/bin/bash

# NOTE: nginx.confã®lua_package_pathã‚’ã‚³ãƒ”ãƒš LUA_PATHã®è¨­å®šãŒå¿…è¦
export LUA_PATH="/usr/local/openresty/lualib/?.lua;/usr/local/openresty/luajit/libs/?.lua;/usr/local/openresty/luajit/share/luajit-2.1.0-beta3/jit/?.lua;/usr/local/openresty/reverse_proxy/src/?.lua;/usr/local/openresty/reverse_proxy/src/auth/?.lua;/usr/local/openresty/lualib/resty/?.lua;/usr/local/openresty/lualib/ngx/?.lua;/usr/local/openresty/?.lua;/usr/local/openresty/luajit21/share/lua/5.1/?.lua"

pushd ../
    # NOTE: ffiã¯luajitã§ã®ã¿ã—ã‹ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ï¼Œhttps://github.com/lunarmodules/busted/issues/369 ã‚’å‚è€ƒã«ä¿®æ­£
    /usr/local/openresty/luajit21/bin/busted --helper=/usr/local/openresty/reverse_proxy/tests/helper.lua -p _test tests
popd
```

---

## æ„Ÿæƒ³

- OpenRestyãŒçµ¡ã‚€ã¨ï¼Œngxã‚’ãƒ¢ãƒƒã‚¯ã—ãªã„ã¨ã„ã‘ãªã„ã®ãŒè¾›ã„ã€‚testã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå·¥æ•°ãŒã‚ãŒã‚Šãã†ãªã‚‰ï¼Œçµåˆãƒ†ã‚¹ãƒˆã«ã‚ã‚‹ç¨‹åº¦å¯„ã›ã‚‹åˆ¤æ–­ã‚’ã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚
- ãªã‚‹ã¹ããƒ¢ãƒƒã‚¯ã—ãªãã¦ã‚‚è‰¯ã„ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ã‘ã‚‹è¨­è¨ˆã«ã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆãŒæ›¸ãã‚„ã™ããªã‚Šãã†
