---
title: "å¤ä¼‘ã¿ã®å®¿é¡Œã§Port Scannerã‚’è‡ªä½œã—ã¦ã¿ãŸâ‘¢~å®Ÿè£…ç·¨~"
emoji: "ğŸ‘€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["portscanner", "python", "rye", "network", "nmap", "å¤ä¼‘ã¿", "è‡ªä½œ"]
published: true
---

## ã“ã‚Œã¾ã§ã®ãŠè©±

- å¤ã ã—ï¼ŒPort Scannerã‚’è‡ªä½œã—ã¦ã¿ãŸã„ --> ã›ã£ã‹ããªã®ã§[my_portscanner](https://github.com/RyosukeDTomita/my_portscanner)ã‚’ä½œã‚‹éç¨‹ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚
- [æŠ€è¡“é¸å®šç·¨](https://zenn.dev/sigma_tom/articles/3de59d1f44aa7e)ã§ã¯ï¼ŒPort Scannerã‚’è‡ªä½œã™ã‚‹ã«ã‚ãŸã£ã¦ã©ã®ã‚ˆã†ãªæŠ€è¡“ã‚’ä½¿ã†ã‹ã‚’è€ƒãˆã¾ã—ãŸã€‚
- [é–‹ç™ºç’°å¢ƒæº–å‚™ç·¨](https://zenn.dev/sigma_tom/articles/e9fed37f0da0a6)Port Scannerã®é–‹ç™ºç’°å¢ƒã‚’æ•´ãˆãŸã€‚
- ä»Šå›ã¯ï¼ŒPort Scannerã®å®Ÿè£…ã‚’ã—ã¦ã„ãã¾ã™ã€‚

---

## å®Ÿè£…ã®å‰ã«

### pythonã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã™ã‚‹

[yt-dlp](https://github.com/yt-dlp/yt-dlp)ã®æ§‹æˆã‚’çœŸä¼¼ã—ãŸã‚‰ã„ã„æ„Ÿã˜ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã§ãã¾ã—ãŸã€‚

å…¨ä½“æ§‹æˆã¨ã—ã¦ã¯ã“ã‚“ãªæ„Ÿã˜

```shell
$ pwd
/home/tomita/my_portscanner/src
$ tree
.
â”œâ”€â”€ my_portscanner
â”‚Â Â  â”œâ”€â”€ get_datetime.py
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ __main__.py
â”‚Â Â  â”œâ”€â”€ options.py
â”‚Â Â  â”œâ”€â”€ scan_tools
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ConnectScan.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Scan.py
â”‚Â Â  â”‚Â Â  â””â”€â”€ SynScan.py
â”‚Â Â  â””â”€â”€ version.py
â””â”€â”€ tests
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ scan_tools
    â”‚Â Â  â”œâ”€â”€ __init__.py
    â”‚Â Â  â”œâ”€â”€ test_ConnectScan.py
    â”‚Â Â  â””â”€â”€ test_SynScan.py
    â”œâ”€â”€ test_get_datetime.py
    â””â”€â”€ test_options.py
```

å…¨ä½“ã®å‹•ä½œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ã¯

1. `rye build`å¾Œã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

    ```shell
    my_portscanner localhost -sS
    ```

2. `my_portscanner`ã¯`src/my_portscanner/__main__.py`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

    ```python
    import my_portscanner


    if __name__ == "__main__":
        my_portscanner.main()
    ```

3. `src/my_portscanner/__init__.py`ã®`main`é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ mainé–¢æ•°ã«å…¨ä½“ã®å‡¦ç†ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚

`__init__.py`ã®mainé–¢æ•°ãŒå†—é•·ã«ãªã‚‹ã¨å…¨ä½“ã®å‡¦ç†ãŒè¿½ã„ã‹ã‘ã«ãããªã‚Šï¼Œãƒ†ã‚¹ãƒˆã‚‚ã—ã«ãããªã‚‹ã®ã§ï¼Œç´°ã‹ã„å‡¦ç†ã¯ãªã‚‹ã¹ãå¤–ã ã—ã™ã‚‹ã“ã¨ã‚’å¿ƒãŒã‘ã¾ã—ãŸã€‚

ä¾‹ãˆã°ï¼Œoptions.pyã¯argparseã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦å¼•æ•°å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

å¼•æ•°ã¯è¦šãˆã‚„ã™ã„ã‚ˆã†ã«`-sS`ã‚„`-sT`ã®ã‚ˆã†ã«nmapã«ä¼¼ãŸå½¢å¼ã«ã—ã¾ã—ãŸã€‚è‡ªä½œãƒ„ãƒ¼ãƒ«ã‚ã‚‹ã‚ã‚‹ãªã®ã§ã™ãŒï¼Œè‡ªåˆ†ã§ä½œã£ãŸå¼•æ•°ã£ã¦ä½œã£ã¦ã„ã‚‹ã¨ãã¯æœ€é«˜ã«ã‚¤ã‚±ã¦ã‚‹ã¨æ€ã†ã®ã«æ•°ãƒ¶æœˆçµŒã¤ã¨å…¨ããŠã¼ãˆã¦ã„ãªã„ã‚“ã§ã™ã‚ˆã­ç¬‘ã€‚

#### buildã«ã‚‚ryeã‚’ä½¿ã†

`rye build`ã‚’ä½¿ã†ã¨ï¼Œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚ŒãŸpythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒdist/

```shell
rye build
ls dist
my_portscanner-0.1.0-py3-none-any.whl  my_portscanner-0.1.0.tar.gz
```

---

## port scanéƒ¨åˆ†ã®å®Ÿè£…

### ã‚¯ãƒ©ã‚¹æ§‹æˆ

- ä»Šå›ã¯ï¼ŒConnect Scanã¨Syn Scanã®2ç¨®é¡ã®ã‚¹ã‚­ãƒ£ãƒ³æ–¹æ³•ã«çµã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
- ä»Šå¾Œï¼Œä»–ã®ã‚¹ã‚­ãƒ£ãƒ³æ–¹æ³•ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã‚‹ã®ã§ï¼Œå„ã‚¹ã‚­ãƒ£ãƒ³æ–¹æ³•ã§å…±é€šã™ã‚‹éƒ¨åˆ†ã‚’Scanã‚¯ãƒ©ã‚¹ã«åˆ‡ã‚Šå‡ºã—ï¼Œå„ã‚¹ã‚­ãƒ£ãƒ³ã‚¯ãƒ©ã‚¹ã«ç¶™æ‰¿ã•ã›ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

~~composition patternã‚’ä½¿ã†ã»ã†ãŒç¶™æ‰¿ã‚ˆã‚Šç¾ã—ãã†ã§ã™ãŒï¼Œé¢å€’ã ã£ãŸã®ã§ç¶™æ‰¿ã«ã—ã¾ã—ãŸã€‚~~

```
â”œâ”€â”€ my_portscanner
â”‚Â Â  â”œâ”€â”€ scan_tools
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ConnectScan.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Scan.py
â”‚Â Â  â”‚Â Â  â””â”€â”€ SynScan.py
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ __main__.py
```

### å„ã‚¹ã‚­ãƒ£ãƒ³æ–¹æ³•ã«ã¤ã„ã¦

ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã®ãŒä¸€ç•ªã¦ã£ã¨ã‚Šæ—©ã„ã§ã™ãŒï¼Œã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã¤ã‹ã¿ã«ãã„ã¨æ€ã†ã®ã§ï¼Œ[nmapã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://nmap.org/man/ja/man-port-scanning-techniques.html)ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

### ã‚¹ã‚­ãƒ£ãƒ³éƒ¨åˆ†ã‚’ä½œã‚‹

ã„ããªã‚Šã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå‡ºã—ã¦ã‚‚ã‚ã‹ã‚Šã«ãã„ã®ã§ï¼Œã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦å°ã•ã„ã‚‚ã®ã‚’ä½œã‚Šï¼Œã“ã‚Œã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ã¦å¤–éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

- Connect Scan

```python3
import socket


target_ip = 127.0.0.1
target_port = 22

s = socket.socket()
errno = s.connect_ex((target_ip, target_port))
s.close()

if errno == 0:
    print(f"TCP port {target_port} is open")
else:
    print(f"TCP port {target_port} is closed")
```

- SYN Scan

```python3
from scapy.all import IP, TCP, sr1

target_ip = 127.0.0.1
target_port = 22

# SYNãƒ‘ã‚±ãƒƒãƒˆã‚’ä½œæˆ
syn_packet = IP(dst=target_ip)/TCP(dport=target_port, flags="S")

response_packet = sr1(syn_packet)

# SYN/ACKãƒ‘ã‚±ãƒƒãƒˆãŒè¿”ã£ã¦ããŸå ´åˆã¯ã€ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã‚‹ã¨åˆ¤æ–­
if (response_packet.haslayer(TCP) and 
    response_packet[TCP].flags == "SA"):
    print(f"TCP port {target_port} is open")
else:
    print(f"TCP port {target_port} is closed")
```

ã“ã‚“ãªæ„Ÿã˜ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‹•ãã‚’å­¦ã‚“ã ã‚‰ï¼ŒClassåŒ–ã—ã¦`__init__.py`ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

---

## å¼•æ•°å‡¦ç†ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

```
â”œâ”€â”€ my_portscanner
â”‚Â Â  â”œâ”€â”€ scan_tools
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ConnectScan.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Scan.py
â”‚Â Â  â”‚Â Â  â””â”€â”€ SynScan.py
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ __main__.py
â”‚Â Â  â”œâ”€â”€ options.py â˜†newâ˜†
```

options.pyã‚’è¿½åŠ ã—ã¦ï¼Œå¼•æ•°å‡¦ç†ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã¯argparseã‚’ä½¿ã„ã¾ã—ãŸã€‚

---

## ãƒ†ã‚¹ãƒˆä½œæˆ

ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¯`rye test`ã§è¡Œãˆã‚‹ã¿ãŸã„ã§ã™ã€‚
`rye test`ã¯`tests`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«ã‚ã‚‹`test_*.py`ã‚’æ¢ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡éƒ¨åˆ†ã¯ãƒ¢ãƒƒã‚¯åŒ–ã—ã¦ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã—ãŸã€‚è‡ªåˆ†ã¯ãƒ¢ãƒƒã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦`unittest.mock`ã‚’ä½¿ã„ã¾ã—ãŸãŒï¼Œ`pytest`ã‚’ä½¿ã†ã¨ã‚‚ã£ã¨ç°¡å˜ã«ãƒ¢ãƒƒã‚¯åŒ–ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚unittestã§ãƒ¢ãƒƒã‚¯ã‚’æ›¸ãã®ã¯åˆã‚ã¦ã ã£ãŸã®ã§å˜ä½“ãƒ†ã‚¹ãƒˆã®å®Ÿè£…ãŒä¸€ç•ªè‹¦åŠ´ã—ã¾ã—ãŸã€‚
ä»Šå›ã¯è¶£å‘³ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãªã®ã§ï¼Œã‚«ãƒãƒ¬ãƒƒã‚¸100%ã¨ã‹ã¯ç›®æŒ‡ã•ãšï¼Œå„æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ãã‹ã‚’ç¢ºèªã™ã‚‹ç¨‹åº¦ã«ç•™ã‚ã¾ã—ãŸã€‚

```python
from io import StringIO
import sys
import unittest
from unittest.mock import patch, MagicMock
from my_portscanner.scan_tools.ConnectScan import ConnectScan


class TestConnectScan(unittest.TestCase):
    def setUp(self):
        """
        ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«æ¯å›å®Ÿè¡Œã•ã‚Œï¼Œ
        socket.socketã®mockã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹ã€‚
        """
        # å…±é€šã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
        self.target_ip = "192.168.150.2"
        self.target_port_list = [22, 80, 443]
        self.expected_open_ports = [22, 443]

        # mock_socket_instanceã®ä½œæˆ
        self.mock_socket_instance = MagicMock()

        # connect_exã®æˆ»ã‚Šå€¤ã‚’è¨­å®š
        def connect_ex_side_effect(address):
            ip, port = address
            if port in self.expected_open_ports:
                return 0  # open
            else:
                return 1  # close

        self.mock_socket_instance.connect_ex.side_effect = connect_ex_side_effect
        return

    @patch("my_portscanner.scan_tools.ConnectScan.socket.socket")
    def test_run(self, mock_socket):
        mock_socket.return_value = self.mock_socket_instance

        scan = ConnectScan(
            target_ip=self.target_ip, target_port_list=self.target_port_list
        )
        open_ports = scan.run()

        self.assertEqual(open_ports, self.expected_open_ports)

    @patch("my_portscanner.scan_tools.ConnectScan.socket.socket")
    def test_print_result(self, mock_socket):
        mock_socket.return_value = self.mock_socket_instance

        scan = ConnectScan(
            target_ip=self.target_ip, target_port_list=self.target_port_list
        )
        scan.run()

        # æ¨™æº–å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        captured_output = StringIO()
        sys.stdout = captured_output

        # print_resultãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè¡Œ
        scan.print_result()

        # æ¨™æº–å‡ºåŠ›ã®å†…å®¹ã‚’å–å¾—
        sys.stdout = sys.__stdout__
        output = captured_output.getvalue().strip()

        # æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›
        expected_output = "PORT       STATE SERVICE\n22/tcp     open  unknown\n443/tcp    open  unknown"

        self.assertEqual(output, expected_output)


if __name__ == "__main__":
    unittest.main()
```

ä¸€ä¾‹ã¨ã—ã¦ConnectScanã®ãƒ†ã‚¹ãƒˆã‚’è¼‰ã›ã¦ãŠãã¾ã™ã€‚
socket.socketã®mockã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ï¼Œconnect_exãŒå‘¼ã°ã‚ŒãŸéš›ã«ï¼Œäºˆã‚è¨­å®šã—ãŸãƒãƒ¼ãƒˆãŒopenã—ã¦ã„ã‚‹å¿œç­”ã‚’è¿”ã™ã‚ˆã†ã«side_effectã‚’è¨­å®šã™ã‚‹ã“ã¨ã§å®Ÿéš›ã«é€šä¿¡ã‚’è¡Œã‚ãšã«ConnectScanã®å„é–¢æ•°ã®ãƒ†ã‚¹ãƒˆãŒè¡Œãˆã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã®æ–¹å¼ã¯ã„ã‚ã‚†ã‚‹ãƒ­ãƒ³ãƒ‰ãƒ³æ´¾ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã«è¿‘ã„ã¨æ€ã‚ã‚Œã¾ã™ã€‚
[å‚è€ƒ: ãƒ†ã‚¹ãƒˆã®æµæ´¾](https://zenn.dev/yum3/articles/i_unit_test_schools)

---

## å®Œæˆã¨ãã®å¾Œã®æ´»å‹•

ã“ã¡ã‚‰ãŒç¾çŠ¶ã®å®Œæˆå“ã«ãªã‚Šã¾ã™ã€‚
[my_portscanner](https://github.com/RyosukeDTomita/my_portscanner)
è¿½åŠ ã§å®Ÿæ–½ã—ãŸäº‹é …ã¨ã—ã¦ã¯ï¼Œ

- GitHub Actionsã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•åŒ–ï¼Œãƒªãƒªãƒ¼ã‚¹ã‚’è‡ªå‹•åŒ–ï¼ŒDocker Container Registryã¸ã®é…å¸ƒã‚’è‡ªå‹•åŒ–
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™
- ä¾‹å¤–å‡¦ç†ã‚’ã¡ã‚ƒã‚“ã¨æ›¸ã
- ã‚ˆã‚Šè©³ç´°ãªã‚¹ã‚­ãƒ£ãƒ³ãŒã§ãã‚‹ã‚ˆã†ã«æ”¹å–„
ç­‰ã‚’è¡Œã„ã¾ã—ãŸã€‚
ä»Šå¾Œï¼Œasync awaitã‚’ä½¿ã£ãŸéåŒæœŸå‡¦ç†ã‚„ï¼Œä»–ã®ã‚¹ã‚­ãƒ£ãƒ³æ–¹æ³•ã®è¿½åŠ ç­‰æ€ã„ã¤ã„ãŸã‚‚ã®ã‚’ã©ã‚“ã©ã‚“å®Ÿè£…ã—ã¦ã„ããŸã„ã§ã™ã€‚
