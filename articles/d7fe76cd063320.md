---
title: "ShellScript/Dockerfileã®å¯èª­æ€§ã‚’ä¸Šã’ã‚‹ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½¿ã„æ–¹"
emoji: "ğŸ‘"
type: "tech"
topics: ["ShellScript", "Docker", "dockerfile", "ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"]
published: true
---


## ã“ã‚Œã¯ä½•?
shell scriptã‚„Dockerfileç­‰ã‚’æ›¸ãæ™‚ã«ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ã†ã¨å®Œçµã‹ã¤ï¼Œã‚ã‹ã‚Šã‚„ã™ãæ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

ä¾‹: ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ã‚ãªã„Dockerfileã®RUN

```
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends sudo && \
    echo 'Creating ${USER_NAME} group.' && \
    addgroup ${USER_NAME} && \
    echo 'Creating ${USER_NAME} user.' && \
    adduser --ingroup ${USER_NAME} --gecos "my_portscanner user" --shell /bin/bash --no-create-home --disabled-password ${USER_NAME} && \
    echo 'using sudo' && \
    usermod -aG sudo ${USER_NAME} && \
    echo "${USER_NAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    rm -rf /var/lib/apt/lists/*

```
ä¾‹: ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ã£ãŸDockerfileã®RUN

```
RUN <<EOF
apt-get update -y
apt-get install -y --no-install-recommends sudo
echo 'Creating ${USER_NAME} group.'
addgroup ${USER_NAME}
echo 'Creating ${USER_NAME} user.'
adduser --ingroup ${USER_NAME} --gecos "my_portscanner user" --shell /bin/bash --no-create-home --disabled-password ${USER_NAME}
echo 'using sudo'
usermod -aG sudo ${USER_NAME}
echo "${USER_NAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
rm -rf /var/lib/lists
EOF
```
è¦‹ãŸç›®ãŒã”ã¡ã‚ƒã”ã¡ã‚ƒã—ãªã„ã‹ã¤ï¼Œ\ã‚„&&ã®ã¤ã‘å¿˜ã‚Œã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã¿ãŸã„ãªäº‹æ•…ã‚’é˜²ã’ã¦ä¾¿åˆ©ã§ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½¿ã„æ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

---

## catã‚³ãƒãƒ³ãƒ‰ã§ã¤ã‹ã†

æœ€ã‚‚æœ‰åãªä¾‹ã¯catã‚³ãƒãƒ³ãƒ‰ã§ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ã†ã“ã¨ã§ã™ã€‚

```shell
cat <<EOF
heredoc> hoge
heredoc> fuga
heredoc> EOF
hoge
fuga
```
ã“ã†ã„ã£ãŸå½¢ã§EOFã‚’å…¥åŠ›ã™ã‚‹ã¾ã§å€¤ã‚’é€£ç¶šã—ã¦å…¥åŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ã†ã“ã¨ã§ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸­ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦å€¤ã‚’æ›¸ãè¾¼ã‚€å‡¦ç†ãŒç°¡æ½”ã«ã‹ã‘ã¾ã™ã€‚
ä»¥ä¸‹ã®ä¾‹ã¯AWSã®EC2ã®UserDataã‚’ä½¿ã£ã¦èµ·å‹•æ™‚ã«docker.httpdã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã®serviceãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

```shell
#!/bin/bash
yum install -y docker
cat <<'EOF' > /etc/systemd/system/docker.httpd.service
[Unit]
Description=httpd Container
After=docker.service
Requires=docker.service
[Service]
Environment="CONTAINER_NAME=httpd-container"
TimeoutStartSec=0
Restart=always
ExecStartPre=-/usr/bin/docker stop ${CONTAINER_NAME}
ExecStartPre=-/usr/bin/docker rm ${CONTAINER_NAME}
ExecStartPre=/usr/bin/docker pull httpd
ExecStart=/usr/bin/docker run --rm --name ${CONTAINER_NAME} -p 80:80 httpd
[Install]
WantedBy=multi-user.target
EOF
systemctl enable --now docker.httpd
systemctl restart docker.httpd
systemctl daemon-reload
```

:::message
EOFã‚’''ã§å›²ã‚€ã“ã¨ã«ã‚ˆã‚Šãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸­ã§ã®å¤‰æ•°å±•é–‹ãŒè¡Œã‚ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
:::

---

## Dockerfileã§ä½¿ã†

ä¸Šè¨˜ã«ã‚‚ç¤ºã—ãŸã‚ˆã†ã«ï¼ŒRUNã§ä½¿ãˆã¾ã™ã€‚

```
RUN <<EOF
set -ex
apt-get update -y
apt-get install -y --no-install-recommends sudo
echo 'Creating ${USER_NAME} group.'
addgroup ${USER_NAME}
echo 'Creating ${USER_NAME} user.'
adduser --ingroup ${USER_NAME} --gecos "my_portscanner user" --shell /bin/bash --no-create-home --disabled-password ${USER_NAME}
echo 'using sudo'
usermod -aG sudo ${USER_NAME}
echo "${USER_NAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
rm -rf /var/lib/lists
EOF
```
:::message
ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®RUNã®å†’é ­ã§`set -ex`ã™ã‚‹ã“ã¨ã§ãƒ‡ãƒãƒƒã‚¯ãŒã—ã‚„ã™ããªã‚‹ã®ã§è¿½è¨˜ã—ã¦ãŠãã¾ã™ã€‚
- `-x`ã§ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã™ã‚‹å‰ã«ãƒ‡ãƒãƒƒã‚¯æƒ…å ±ã‚’å‡ºã—ã¦ãã‚Œã¾ã™ã€‚

  ```
  # -xãªã—
  5.082 6 packages can be upgraded. Run 'apt list --upgradable' to see them.
  5.085
  5.085 WARNING: apt does not have a stable CLI interface. Use with caution in scripts.
  ```

  ```
  # -xã‚ã‚Š
  3.654 6 packages can be upgraded. Run 'apt list --upgradable' to see them.
  3.655 + apt install -y sud
  3.657
  3.657 WARNING: apt does not have a stable CLI interface. Use with caution in scripts.
  ```

- `-e`ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«é€”ä¸­ã§buildã‚’æ­¢ã‚ã¦ãã‚Œã¾ã™ã€‚
    - `-e`ãªã— --> é€”ä¸­ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚æœ€å¾Œã®ã‚³ãƒãƒ³ãƒ‰ãŒæˆåŠŸã—ã¦ã„ã‚Œã°æ­¢ã¾ã‚‰ãªã„

    ```dockerfile
    FROM python:3.12.4-slim-bullseye
    RUN <<EOF
    apt update -y
    apt-get install -y --no-install-recommends sud # ã‚ã–ã¨ã‚¿ã‚¤ãƒã—ãŸ
    ls # æˆåŠŸã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
    EOF
    ```

    ```shell
    docker buildx build .
    [+] Building 1.2s (6/6) FINISHED                                                                                                   docker:default
     => [internal] load build definition from Dockerfile                                                                                         0.0s
     => => transferring dockerfile: 148B                                                                                                         0.0s
     => [internal] load metadata for docker.io/library/python:3.12.4-slim-bullseye                                                               1.0s
     => [internal] load .dockerignore                                                                                                            0.0s
     => => transferring context: 2B                                                                                                              0.0s
     => [1/2] FROM docker.io/library/python:3.12.4-slim-   bullseye@sha256:26ce493641ad3b1c8a6202117c31340c7bbb2dc126f1aeee8ea3972730a81dc6         0.0s
     => CACHED [2/2] RUN <<EOF (apt update -y...)                                                                                                0.0s
     => exporting to image                                                                                                                       0.0s
     => => exporting layers                                                                                                                      0.0s
     => => writing image sha256:fc59842d7a59c1937163ce3712d71d2d56fd4fe76a7649f5f9665c7d7ef67e9a                                               0.0s
    ```
    - `-e`ã‚ã‚Š --> é€”ä¸­ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ®µéšã§æ­¢ã¾ã‚‹ã€‚

    ```shell
    docker buildx build .
     > [2/2] RUN <<EOF (set -e...):
    0.192
    0.192 WARNING: apt does not have a stable CLI interface. Use with caution in scripts.
    0.192
    0.342 Get:1 http://deb.debian.org/debian bullseye InRelease [116 kB]
    0.373 Get:2 http://deb.debian.org/debian-security bullseye-security InRelease [27.2 kB]
    0.386 Get:3 http://deb.debian.org/debian bullseye-updates InRelease [44.1 kB]
    0.430 Get:4 http://deb.debian.org/debian bullseye/main amd64 Packages [8066 kB]
    1.644 Get:5 http://deb.debian.org/debian-security bullseye-security/main amd64 Packages [287 kB]
    1.679 Get:6 http://deb.debian.org/debian bullseye-updates/main amd64 Packages [18.8 kB]
    2.506 Fetched 8559 kB in 2s (3711 kB/s)
    2.506 Reading package lists...
    2.843 Building dependency tree...
    2.929 Reading state information...
    2.938 6 packages can be upgraded. Run 'apt list --upgradable' to see them.
    2.944 Reading package lists...
    3.260 Building dependency tree...
    3.344 Reading state information...
    3.394 E: Unable to locate package sud
    ------
    Dockerfile:2
    --------------------
       1 |     FROM python:3.12.4-slim-bullseye
       2 | >>> RUN <<EOF
       3 | >>> set -e
       4 | >>> apt update -y
       5 | >>> apt-get install -y --no-install-recommends sud
       6 | >>> ls
       7 | >>> EOF
       8 |
    --------------------
    ERROR: failed to solve: process "/bin/sh -c set -e\napt update -y\napt-get install -y --no-install-recommends sud\nls\n" did not complete successfully: exit code: 100
    ```
è¿½è¨˜: ã‚³ãƒ¡ãƒ³ãƒˆã§æ•™ãˆã¦ã„ãŸã ã„ãŸã®ã§ã™ãŒï¼Œ

```dockerfile
RUN <<EOF bash -ex
```
ã®ã‚ˆã†ã«æ›¸ã‘ã‚‹ã®ã§ã“ã£ã¡ã®ã»ã†ãŒæœ¬è³ªçš„ãªå‡¦ç†ãŒ`RUN`ã®ä¸­ã«å…¥ã‚‹ã®ã§å¯èª­æ€§ãŒé«˜ãã†ã§ã™ã€‚

:::


---

## Terraformã§ä½¿ã†

terraformã§user_dataã«å¯¾ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’æŠ•å…¥ã™ã‚‹éš›ã«ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒä½¿ãˆã¾ã™ã€‚
ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å…¥ã‚Œå­ã§ä½¿ã†éš›ã«ã¯EOF2ã‚’ä½¿ã„ã¾ã™ã€‚

```terraformf
resource "aws_instance" "example" {
  ami           = "ami-00c79d83cf718a893"
  instance_type = "t3.micro"
  # attach IAM Role
  iam_instance_profile = aws_iam_instance_profile.ssm_instance_profile.name

  tags = {
    Name = "sigma-ec2"
  }

  user_data = <<EOF
#!/bin/bash
yum install -y docker
cat <<'EOF2' > /etc/systemd/system/docker.httpd.service
[Unit]
Description=httpd Container
After=docker.service
Requires=docker.service
[Service]
Environment="CONTAINER_NAME=httpd-container"
TimeoutStartSec=0
Restart=always
ExecStartPre=-/usr/bin/docker stop $${CONTAINER_NAME}
ExecStartPre=-/usr/bin/docker rm $${CONTAINER_NAME}
ExecStartPre=/usr/bin/docker pull httpd
ExecStart=/usr/bin/docker run --rm --name $${CONTAINER_NAME} -p 80:80 httpd
[Install]
WantedBy=multi-user.target
EOF2
systemctl enable --now docker.httpd
systemctl restart docker.httpd
systemctl daemon-reload
EOF
}
```

:::message
TerraformãŒ`$`ã‚’è§£é‡ˆã—ãªã„ã‚ˆã†ã«`$${CONTAINER_NAME}`ã®ã‚ˆã†ã«ã—ã¦ã«ã—ã¦escapeã—ã¦ã„ã¾ã™ã€‚
EOF2ã‚’''ã§å›²ã‚“ã§ã„ã‚‹ã®ã¯ä¸Šè¨˜ã¨åŒã˜ã§å¤‰æ•°å±•é–‹ã‚’ã—ãªã„ãŸã‚ã§ã™ã€‚
:::

---

## ç·æ‹¬

- ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ã†ã“ã¨ã§è¦‹ãŸç›®ãŒã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ã§å¯èª­æ€§ãŒé«˜ããªã‚‹ã®ã§ãŠã™ã™ã‚ã€‚
- ä»–ã«ã‚‚ä½¿ãˆã‚‹ä¾‹ã‚’æ¢ã—ã¦ã¿ãŸã„ã€‚
